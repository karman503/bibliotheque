{% extends "base.html" %}
{% block content %}
<!-- Paramètres -->
<div class="container-fluid p-4">

    <!-- Titre -->
    <div class="mb-4">
        <h2 class="fw-bold">Paramètres</h2>
        <p class="text-muted">Configurez votre compte et les paramètres de la bibliothèque</p>
    </div>

    <!-- Navigation onglets -->
    <div class="mb-4">
        <ul class="nav nav-tabs border-bottom-2" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="profil-tab" data-bs-toggle="tab" data-bs-target="#profil"
                    type="button" role="tab" aria-controls="profil" aria-selected="true">Profil</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="securite-tab" data-bs-toggle="tab" data-bs-target="#securite" type="button"
                    role="tab" aria-controls="securite" aria-selected="false">Sécurité</button>
            </li>
            {% if current_user.role in ['admin', 'bibliothecaire'] %}
            <li class="nav-item">
                <button class="nav-link" id="bibliotheque-tab" data-bs-toggle="tab" data-bs-target="#bibliotheque"
                    type="button" role="tab" aria-controls="bibliotheque" aria-selected="false">Bibliothèque</button>
            </li>
            {% endif %}
        </ul>
    </div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="profil" role="tabpanel" aria-labelledby="profil-tab">

            <!-- Informations personnelles -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="fw-semibold mb-4">Informations personnelles</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('update_profil') }}">
                                <label class="form-label">Nom d'utilisateur</label>
                                <input type="text" name="username" class="form-control"
                                    value="{{ current_user.username }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" value="{{ current_user.email }}"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" name="telephone" class="form-control"
                                value="{{ current_user.adherent.telephone if current_user.adherent else '' }}">
                        </div>

                        <!-- Changer le mot de passe -->
                        <div class="col-12">
                            <h6 class="mt-3 mb-2">Modifier le mot de passe</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Mot de passe actuel</label>
                                    <input type="password" name="current_password" class="form-control"
                                        placeholder="Laisser vide si pas de changement">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Nouveau mot de passe</label>
                                    <input type="password" name="new_password" class="form-control"
                                        placeholder="Nouveau mot de passe">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Confirmer le nouveau mot de passe</label>
                                    <input type="password" name="confirm_new_password" class="form-control"
                                        placeholder="Confirmer le mot de passe">
                                </div>
                            </div>
                        </div>
                        {% if current_user.role == 'admin' %}
                        <div class="col-md-6">
                            <label class="form-label">Poste</label>
                            <input type="text" name="poste" class="form-control" placeholder="(optionnel)">
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-3">
                        <input type="hidden" name="current_password" value="">
                        <button class="btn btn-primary">Sauvegarder les modifications</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Upload photo de profil -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="fw-semibold mb-4">Photo de profil</h5>
                    <div class="d-flex align-items-center gap-3">
                        {% if current_user.image %}
                        <img src="{{ url_for('static', filename='uploads/profiles/' + current_user.image) }}"
                            alt="Profil" class="rounded-circle" width="80" height="80" style="object-fit:cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                            style="width:80px; height:80px;">{{ current_user.username[:1]|upper }}</div>
                        {% endif %}

                        <form method="POST" action="{{ url_for('upload_image') }}" enctype="multipart/form-data">
                            <div class="mb-2">
                                <input type="file" name="image" accept="image/*" class="form-control">
                            </div>
                            <button class="btn btn-outline-primary">Mettre à jour la photo</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>

        <div class="tab-pane fade" id="securite" role="tabpanel" aria-labelledby="securite-tab">
            <div class="row g-4">

                <div class="col-12">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <h5 class="fw-semibold mb-4">Sécurité</h5>
                            <p class="text-muted">Actions sensibles du compte</p>

                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#confirmDeleteModal">Supprimer mon compte</button>
                                {% if current_user.role == 'admin' %}
                                <form method="POST" action="{{ url_for('delete_all_non_admins') }}"
                                    onsubmit="return confirm('Confirmer la suppression de tous les comptes non-admin (sauf votre compte) ?');">
                                    <button type="submit" class="btn btn-danger">Supprimer tous les comptes
                                        non-admin</button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if current_user.role in ['admin','bibliothecaire'] %}
                <!-- Supprimer un utilisateur spécifique -->
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="fw-semibold">Supprimer un utilisateur</h5>
                            <p class="text-muted small">Sélectionnez un utilisateur (hors admins si vous n'êtes pas
                                admin)</p>
                            <form method="POST" action="{{ url_for('delete_user') }}"
                                onsubmit="return confirm('Confirmer la suppression de cet utilisateur ?');">
                                <div class="mb-3">
                                    <label class="form-label">Utilisateur</label>
                                    <select name="user_id" class="form-select" required>
                                        <option value="">-- Choisir un utilisateur --</option>
                                        {% for u in users_non_admin %}
                                        <option value="{{ u.id }}">{{ u.username }} &nbsp;({{ u.role }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-outline-danger">Supprimer l'utilisateur</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Supprimer un adhérent -->
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="fw-semibold">Supprimer un adhérent</h5>
                            <p class="text-muted small">Sélectionnez un adhérent et toutes ses données seront supprimées
                            </p>
                            <form method="POST" action="{{ url_for('delete_adherent') }}"
                                onsubmit="return confirm('Confirmer la suppression de cet adhérent et de ses données ?');">
                                <div class="mb-3">
                                    <label class="form-label">Adhérent</label>
                                    <select name="adherent_id" class="form-select" required>
                                        <option value="">-- Choisir un adhérent --</option>
                                        {% for a in adherents %}
                                        <option value="{{ a.id }}">{{ a.nom }} {{ a.prenom }} (ID {{ a.id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-outline-danger">Supprimer l'adhérent</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

        {% if current_user.role in ['admin', 'bibliothecaire'] %}
        <div class="tab-pane fade" id="bibliotheque" role="tabpanel" aria-labelledby="bibliotheque-tab">
            <div class="row g-4">

                <!-- Paramètres des emprunts -->
                <div class="col-12">
                    <div class="card shadow-sm border-light">
                        <div class="card-body">
                            <h3 class="h5 mb-4">Paramètres des emprunts</h3>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre maximum d'emprunts par adhérent</label>
                                    <input type="number" class="form-control" value="3">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Durée d'emprunt (jours)</label>
                                    <input type="number" class="form-control" value="14">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nombre maximum de prolongations</label>
                                    <input type="number" class="form-control" value="2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Amende par jour de retard (€)</label>
                                    <input type="number" step="0.1" class="form-control" value="0.5">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button class="btn btn-primary">Sauvegarder les paramètres</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sauvegarde et restauration -->
                <div class="col-12">
                    <div class="card shadow-sm border-light">
                        <div class="card-body">
                            <h3 class="h5 mb-4">Sauvegarde et restauration</h3>

                            <!-- Sauvegarde automatique -->
                            <div class="d-flex justify-content-between align-items-center p-3 mb-3 border rounded-3">
                                <div>
                                    <p class="mb-1 fw-medium">Sauvegarde automatique</p>
                                    <p class="mb-0 small text-secondary">Dernière sauvegarde: Aujourd'hui à 03:00</p>
                                </div>
                                <button class="btn btn-outline-secondary">
                                    <i class="ri-download-line me-2"></i>Télécharger
                                </button>
                            </div>

                            <!-- Exporter les données -->
                            <div class="d-flex justify-content-between align-items-center p-3 border rounded-3">
                                <div>
                                    <p class="mb-1 fw-medium">Exporter les données</p>
                                    <p class="mb-0 small text-secondary">Exporter toutes les données en format CSV</p>
                                </div>
                                <button class="btn btn-outline-secondary">
                                    <i class="ri-file-excel-line me-2"></i>Exporter
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% endif %}

        <!-- Modal confirmation suppression -->
        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-4">
                    <h5 class="mb-3">Confirmer la suppression du compte</h5>
                    <p>Cette action est irréversible. Entrez votre mot de passe pour confirmer.</p>
                    <form method="POST" action="{{ url_for('delete_account') }}">
                        <div class="mb-3">
                            <label class="form-label">Mot de passe</label>
                            <input type="password" name="password" class="form-control" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danger">Supprimer le compte</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    // Activate tab from URL hash or ?tab= query param
    (function () {
        function activateTab(name) {
            try {
                var tabButton = document.querySelector('[data-bs-target="#' + name + '"]');
                if (tabButton) {
                    var tab = new bootstrap.Tab(tabButton);
                    tab.show();
                }
            } catch (e) {
                console.error('Erreur activation onglet:', e);
            }
        }

        // If query param tab= is present, use it
        var params = new URLSearchParams(window.location.search);
        var tabParam = params.get('tab');
        if (tabParam) {
            activateTab(tabParam);
            return;
        }

        // Otherwise check hash (#profil, #securite...)
        var hash = (window.location.hash || '').replace('#', '');
        if (hash) {
            activateTab(hash);
        }
    })();
</script>
{% endblock %}